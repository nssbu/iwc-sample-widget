<html>
<head>
    <link rel="stylesheet" href="../style/main.css">
</head>
<body>
    <div class="content">
        <div>
            <label>Connection status: </label>
            <span id="connection"></span>
        </div>

        <div>
            <label>Cart</label>
            <div>
                <label>Total: $</label><span id="total"></span> <br>
                <label>Count: </label><span id="count"></span>
            </div>
        </div>

        <button id="add">Add Item</button>
    </div>

    <script src="js/utils.js"></script>
    <script src="http://localhost:13000/js/ozpIwc-client.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script>
        var iwc = new ozpIwc.Client('http://localhost:13000');

        // Only need to call connect() explicitly when we need to handle the promise it returns
        iwc.connect().then(function() {
            $('#connection').text('Connected to IWC Bus with address: ' + iwc.address);
        }).catch(function(error) {
            $('#connection').text('Erro: ' + error);
        });

        var logShoppingCartList = function(value) {
            console.log('Cart list', value);
        };

        var watchShoppingCart = function(change, done) {
            console.log('shoppingCart change', change);

            $('#total').text(change.newValue.total);
            $('#count').text(change.newValue.count);
        };

        var watchAmazonCart = function(change, done) {
            console.log('amazonCart change', change);

            $('#total').text(change.newValue.total);
            $('#count').text(change.newValue.count);
        };

        // Setup root-level shopping cart data
        var shoppingCart = new iwc.data.Reference('/shoppingCart', { collect: true });
        shoppingCart.set({ total: 0, count: 0 });

        // Setup amazon shopping cart data
        var amazonCart = new iwc.data.Reference('/shoppingCart/amazon', { collect: true });
        amazonCart.set({ total: 0, count: 0 });

        // Log the list and setup some handlers
        shoppingCart.list().then(logShoppingCartList);
        shoppingCart.watch(watchShoppingCart);
        amazonCart.watch(watchAmazonCart);

        // Add a click handler to create and add random items
        $('#add').click(function() {
            var newItem = window.createItem('amazon.com');
            var itemRef = new iwc.data.Reference('/shoppingCart/amazon/' + newItem.upc);
            itemRef.set(newItem);
        });
    </script>
</body>
</html>
